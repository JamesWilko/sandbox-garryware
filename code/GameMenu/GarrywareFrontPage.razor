@using System
@using System.Threading.Tasks
@using Sandbox;
@using Sandbox.UI;

@namespace Garryware.UI.GameMenu

@attribute [StyleSheet]
@inherits Panel;

<root style="flex-direction: column;">

    <div style="flex-direction: row; height: 100%;">
        <div class="left-panel">
            
            <div class="game-title" onclick="@OpenGameInfo">
            </div>

            <span style="margin-bottom: auto"></span>

            <div class="control-cards">
                @if (Game.InGame)
                {
                    <MenuCard onclick="@ReturnToLobby">
                        <Icon><svg class="icon" Src="ui/play-circle.svg" Color=@Color.White.Hex></svg></Icon>
                        <Title>Keep Playing</Title>
                    </MenuCard>
                    <MenuCard onclick="@LeaveGame">
                        <Icon><svg class="icon" Src="ui/exit.svg" Color=@Color.White.Hex></svg></Icon>
                        <Title>Leave Game</Title>
                    </MenuCard>
                }
                else
                {
                    <MenuCard onclick="@CreateLobby">
                        <Icon><svg class="icon" Src="ui/play-circle.svg" Color=@Color.White.Hex></svg></Icon>
                        <Title>New Game</Title>
                    </MenuCard>
                    <MenuCard onclick="@OpenServerList">
                        <Icon><svg class="icon" Src="ui/server.svg" Color=@Color.White.Hex></svg></Icon>
                        <Title>Find Game</Title>
                    </MenuCard>
                    <MenuCard onclick="@OpenSettings">
                        <Icon><svg class="icon" Src="ui/settings.svg" Color=@Color.White.Hex></svg></Icon>
                        <Title>Settings</Title>
                    </MenuCard>
                }
            </div>
            
        </div>
        
        <div class="right-panel">
            
            <span style="margin-bottom: 50px"></span>
            <div class="info-box">
                <svg class="icon" Src="ui/info-circle.svg" Color=@Color.White.Hex></svg>
                Just like s&box, GarryWare is a work in progress! Occasionally you might run into an issue, please report them to us on the s&box discord or our GitHub.
            </div>
            
            <span style="margin-bottom: auto"></span>
            
            <div class="menu-section">
                <div class="header">
                    <svg class="icon" Src="ui/user-heart.svg" Color=@Color.White.Hex></svg>
                    Lobbies
                </div>
                <div class="content background">
                    <div @ref="LobbiesListPanel" class="entries">
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <span style="height: 20px"></span>
    <div class="controls">
        <a class="button" @onclick="@Game.Menu.Close">Quit</a>
        <a class="button" @onclick="@RefreshLobbiesList">Refresh Lobbies</a>
    </div>
    
    <div class="loading-overlay" @ref="loadingOverlay">
        <div class="loading">
            <svg class="spinner" Src="ui/star-rings.svg" Color=@Color.White.Hex></svg>
        </div>
    </div>
    
</root>

@code
{
    private Panel loadingOverlay;
    private bool isCreatingLobby;

    private Panel LobbiesListPanel { get; set; }
    private Label RefreshingLobbiesLabel { get; set; }
    private Label NoLobbiesLabel { get; set; }

    protected override void OnAfterTreeRender(bool firstTime)
    {
        base.OnAfterTreeRender(firstTime);

        if (firstTime)
        {
            RefreshLobbiesList();
        }
    }

    public override void OnHotloaded()
    {
        base.OnHotloaded();

        RefreshLobbiesList();
    }
    
    private async void CreateLobby()
    {
        if(isCreatingLobby)
            return;

        isCreatingLobby = true;
        ShowLoadingSpinner();
        
        var lobby = await Game.Menu.CreateLobbyAsync(16, "garryware", true);
        lobby.Title = $"{Game.UserName}'s Lobby";

        isCreatingLobby = false;
        HideLoadingSpinner();
        
        this.Navigate("/lobby");
    }
    
    private void ReturnToLobby()
    {
        this.Navigate("/active");
    }
    
    private void OpenServerList()
    {
        var options = new Sandbox.Modals.ServerListModalOptions();
        options.TargetGame = Game.Menu.Package.FullIdent;
        options.OnSelected = (server) =>
        {
            Game.Menu.ConnectToServer(server.SteamId);
        };

        Game.Overlay.ShowServerList(options);
    }

    private void OpenSettings()
    {
        this.Navigate("/settings");
    }
    
    private void OpenGameInfo()
    {
        Game.Overlay.ShowPackageModal(Game.Menu.Package.FullIdent);
    }
    
    private void OpenOrganization()
    {
        Game.Overlay.ShowOrganizationModal(Game.Menu.Package.Org);
    }

    private void LeaveGame()
    {
        Game.Menu.LeaveServer("Leaving");
    }

    private void ShowLoadingSpinner()
    {
        loadingOverlay.Style.Opacity = 1f;
    }

    private void HideLoadingSpinner()
    {
        loadingOverlay.Style.Opacity = 0f;
    }

    private async void RefreshLobbiesList()
    {
        if (LobbiesListPanel == null)
            return;
        
        LobbiesListPanel.DeleteChildren(true);
        LobbiesListPanel.AddChild(new Label()
        {
            Text = "Refreshing..."
        });
        
        Log.Info($"Querying lobbies");
        var lobbiesTask = Game.Menu.QueryLobbiesAsync();
        await lobbiesTask;

        LobbiesListPanel.DeleteChildren(true);
        Log.Info($"Retrieved {lobbiesTask.Result.Length} lobbies");
        if (lobbiesTask.Result.Length == 0)
        {
            LobbiesListPanel.AddChild(new Label()
            {
                Text = "There's no-one here right now, why not start the party?"
            });
        }
        else
        {
            foreach (var lobby in lobbiesTask.Result)
            {
                LobbiesListPanel.AddChild(new JoinLobbyButton()
                {
                    Lobby = lobby,
                });
            }
        }
    }
    
}
